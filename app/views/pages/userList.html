#{extends '/layout/default.html' /} 
#{set title:'User List' /}

#{set 'moreScripts'} 
	<script type='text/javascript'>
	// current page
	var currentPage = 0;
	var isLastPage = false;
	
	$(function() {
		listUsers();
		$("#queryForm").submit(function() {
			currentPage = 0;
			isLastPage = false;
			$('#list').empty();
			loadUserList();
			return false;
		});
	});	
	
	function loadUserList(){
		$.ajax({url: "@{Users.list()}",
            dataType: "json",
            data:{"queryName" : $("#queryName").val(), "paginationList.currentPage" : currentPage},
            async: true,
            type: "post",
            beforeSend: function() {
                $.mobile.showPageLoadingMsg(true);
            },
            complete: function() {
                $.mobile.hidePageLoadingMsg();
            },
            success: function (data) {
            	if(data && data.recordList && data.recordList.length > 0){
    				$(data.recordList).each(function(i){
    					var html = "<li>";
    					html += "<a href=''>";
    					html += "<h3>" + this.realname + "</h3>";
    					html += "<p class='topic'><strong>" + this.usertype + "</strong></p>";
    					html += "<p class='ui-li-aside'><strong>Status:" + this.status ? "Active" : "Inactive" + "</strong></p>";
    					html += "</a>";
    					html += "<a href='javascript:deleteUser(" + this.id + ")' class='delete'>Delete</a>";
    					html += "</li>";
    					$("#list").append(html);
    				});
    				$('#list').listview('refresh');
    				currentPage++;
    			}else{
    				alert("No More Data...");
    				isLastPage = true;
    			}
            	
            },
            error: function (request,error) {
                //alert('Network error has occurred please try again!');
            }
        });
		
		
	}
	
	function listUsers(){
        var timer    = setInterval(function () { scrollOK = true; }, 500);
        var scrollOK = true;
        var count    = 5;

        $(window).on('scroll', function () {
            if (scrollOK) {
                scrollOK = false;
                if ($(this).scrollTop() + $(this).height() >= ($(document).height() - count)) {
                   	// Load content here 
                   	if(!isLastPage){
                		loadUserList();
                   	}
                }
            }
        });
	}
	
	function deleteUser(id){
		$( "#confirm" ).popup( "open" );
        // Proceed when the user confirms
        $( "#confirm #yes" ).one( "click", function() {
            // Remove with a transition
            alert("delete" + id);
            $( "#confirm #cancel" ).off();
        });
        // Remove active state and unbind when the cancel button is clicked
        $( "#confirm #cancel" ).one( "click", function() {
            alert("no action" + id);
            $( "#confirm #yes" ).off();
        });

	}
	
	function confirmAndDelete( listitem, transition ) {
        // Highlight the list item that will be removed
        listitem.addClass( "ui-btn-down-d" );
        // Inject topic in confirmation popup after removing any previous injected topics
        $( "#confirm .topic" ).remove();
        listitem.find( ".topic" ).clone().insertAfter( "#question" );
        // Show the confirmation popup
        $( "#confirm" ).popup( "open" );
        // Proceed when the user confirms
        $( "#confirm #yes" ).on( "click", function() {
            // Remove with a transition
            if ( transition ) {
                listitem
                    // Remove the highlight
                    .removeClass( "ui-btn-down-d" )
                    // Add the class for the transition direction
                    .addClass( transition )
                    // When the transition is done...
                    .on( "webkitTransitionEnd transitionend otransitionend", function() {
                        // ...the list item will be removed
                        listitem.remove();
                        // ...the list will be refreshed and the temporary class for border styling removed
                        $( "#list" ).listview( "refresh" ).find( ".ui-li.border" ).removeClass( "border" );
                    })
                    // During the transition the previous list item should get bottom border
                    .prev( "li.ui-li" ).addClass( "border" );
            }
            // If it's not a touch device or the CSS transition isn't supported just remove the list item and refresh the list
            else {
                listitem.remove();
                $( "#list" ).listview( "refresh" );
            }
        });
        // Remove active state and unbind when the cancel button is clicked
        $( "#confirm #cancel" ).on( "click", function() {
            listitem.removeClass( "ui-btn-down-d" );
            $( "#confirm #yes" ).off();
        });
    }
	
	</script>
#{/set} 

<form id="queryForm">
	<div style="height:70px;">
		<input type="search" name="queryName" id="queryName" value="" placeholder="Search The User Name...">
	</div>
	
	<ul id="list" data-role="listview" data-icon="false" data-split-icon="delete" data-split-theme="c">
		
	</ul>
</form>

<div id="confirm" class="ui-content" data-role="popup" data-theme="none">
	<p id="question">Are you sure you want to delete</p>
   	<div class="ui-grid-a">
    	<div class="ui-block-a">
       		<a id="yes" data-role="button" data-mini="true" data-shadow="false" data-theme="b" data-rel="back">Yes</a>
      	</div>
        <div class="ui-block-b">
        	<a id="cancel" data-role="button" data-mini="true" data-shadow="false" data-theme="b" data-rel="back">Cancel</a>
      	</div>
	</div>
</div><!-- /popup -->